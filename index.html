<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>AllInOne Reborn</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.ui.min.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css" crossorigin="anonymous">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      background: #000;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .shaka-video-container {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    video {
      width: 100%;
      height: 100%;
      background: #000;
      object-fit: contain;
    }

    .shaka-spinner-container,
    .shaka-spinner,
    .shaka-spinner-svg {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    .error-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }

    .error-modal.hidden { display: none !important; }

    .error-content {
      background: #222;
      border-radius: 15px;
      padding: 25px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      color: white;
    }

    .error-content h3 { color: #ff6b6b; margin-bottom: 15px; }
    .channel-list { display:none; }

    .close-btn {
      background: #ff4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>

<body>

  <div id="errorModal" class="error-modal hidden">
    <div class="error-content">
      <h3 id="errorTitle">@allinone_reborn</h3>
      <p id="errorMessage"></p>
      <button class="close-btn" onclick="document.getElementById('errorModal').classList.add('hidden')">Close</button>
    </div>
  </div>

  <div class="shaka-video-container" data-shaka-player data-shaka-controls>
    <video autoplay muted playsinline preload="metadata"></video>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", async () => {

  const params = new URLSearchParams(window.location.search);
  const channelId = params.get("play");

  if (!channelId) {
    showError("No Channel ID", "Please use format: ?play=CHANNEL_ID");
    return;
  }

  let channelList = [];

  try {
    const response = await fetch("https://allinonereborn.xyz/jstrweb2/jstr.php");
    channelList = await response.json();
  } catch (error) {
    showError("Connection Error", "Unable to fetch channel list from server.");
    return;
  }

  const channel = channelList.find(c => c.channel_id == channelId);

  if (!channel) {
    showError("Channel Not Found", "No channel found for ID: " + channelId);
    return;
  }

  if (!channel.mpd || channel.mpd.trim() === "") {
    showError("Stream Error", channel.name + " is not available right now.");
    return;
  }

  // Shaka setup
  shaka.polyfill.installAll();

  if (!shaka.Player.isBrowserSupported()) {
    showError("Browser Not Supported", "Shaka Player not supported.");
    return;
  }

  const video = document.querySelector("video");
  video.autoplay = true;
  video.muted = true;
  
  const player = new shaka.Player(video);
  const container = document.querySelector(".shaka-video-container");
  const ui = new shaka.ui.Overlay(player, container, video);

  ui.configure({
    controlPanelElements: [
      "play_pause",
      "time_and_duration",
      "mute",
      "volume",
      "spacer",
      "quality",
      "picture_in_picture",
      "fullscreen"
    ],
    addBigPlayButton: true,
    seekBarColors: {
      base: "rgba(255,255,255,.2)",
      buffered: "rgba(255,255,255,.4)",
      played: "rgb(255,0,0)"
    }
  });

  // DRM Config
  const drmConfig = channel.drm && Object.keys(channel.drm).length > 0
    ? { clearKeys: channel.drm }
    : {};

  player.configure({
    drm: drmConfig,
    streaming: {
      bufferingGoal: 25,
      rebufferingGoal: 5,
      bufferBehind: 30,
      retryParameters: {
        timeout: 15000,
        maxAttempts: 3
      }
    }
  });

  // Request filter (Headers & Tokens)
  player.getNetworkingEngine().registerRequestFilter((type, request) => {

    if (channel.userAgent) {
      request.headers["User-Agent"] = channel.userAgent;
    }

    if (channel.referer) {
       request.headers["Referer"] = channel.referer;
    }

    if (channel.token) {
      request.headers["Cookie"] = channel.token;

      if (
        type === shaka.net.NetworkingEngine.RequestType.MANIFEST ||
        type === shaka.net.NetworkingEngine.RequestType.SEGMENT
      ) {
        if (!request.uris[0].includes(channel.token)) {
          const separator = request.uris[0].includes("?") ? "&" : "?";
          request.uris[0] += separator + channel.token;
        }
      }
    }
  });

  try {
    console.log("Loading Channel:", channel.name);
    await player.load(channel.mpd);
    document.title = channel.name + " | AllInOne Reborn";
  } catch (error) {
    console.error("Error code", error.code, "object", error);
    showError("Stream Error", "Error Code: " + error.code + " - " + error.message);
  }

  function showError(title, message) {
    document.getElementById("errorTitle").textContent = title;
    document.getElementById("errorMessage").innerHTML = message;
    document.getElementById("errorModal").classList.remove("hidden");
  }

});
</script>
</body>
</html>
